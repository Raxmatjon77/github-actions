stages:
  - build
  - deploy

variables:
  TELEGRAM_BOT_TOKEN: "8028072110:AAG5ERdmz3za_N5YXM9JPp8JTMO6XEqcAv8"
  TELEGRAM_CHAT_ID: "1955031743"

build-job:
  stage: build
  script:
    - |
      send_message() {
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="$1"
      }
      send_message "üöÄ Build started\nBranch: ${CI_COMMIT_BRANCH}\nAuthor: ${CI_COMMIT_AUTHOR}\nMessage: ${CI_COMMIT_MESSAGE}\nTime: $(date '+%Y-%m-%d %H:%M:%S')"
    - docker build -t qazo-namoz-image .
  only:
    - main
  after_script:
    - |
      send_message() {
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="$1"
      }
      if [[ "$CI_JOB_STATUS" == "failed" ]]; then
        send_message "‚ùå Build failed\nBranch: ${CI_COMMIT_BRANCH}\nAuthor: ${CI_COMMIT_AUTHOR}\nMessage: ${CI_COMMIT_MESSAGE}\nTime: $(date '+%Y-%m-%d %H:%M:%S')"
      fi

deploy-job:
  stage: deploy
  script:
    - docker-compose up -d
  only:
    - main
  after_script:
    - |
      send_message() {
        curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
          -d chat_id="${TELEGRAM_CHAT_ID}" \
          -d text="$1"
      }
      if [[ "$CI_JOB_STATUS" == "success" ]]; then
        send_message "‚úÖ Deploy succeeded\nBranch: ${CI_COMMIT_BRANCH}\nAuthor: ${CI_COMMIT_AUTHOR}\nMessage: ${CI_COMMIT_MESSAGE}\nTime: $(date '+%Y-%m-%d %H:%M:%S')"
      else
        send_message "‚ùå Deploy failed\nBranch: ${CI_COMMIT_BRANCH}\nAuthor: ${CI_COMMIT_AUTHOR}\nMessage: ${CI_COMMIT_MESSAGE}\nTime: $(date '+%Y-%m-%d %H:%M:%S')"
      fi
